<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>方块消除游戏 - 技能系统</title>
		<link rel="stylesheet" href="./css/style.css" />
	</head>
	<body>
		<div class="game">
			<div class="game-container" id="gameContainer">
				<div class="game-tip" style="display: none">
					<div class="tip-title">提示</div>
					<div class="tip-content">
						<div>是否激活【北极熊<span>X2</span>】</div>
						<div class="tip-anmail"></div>
						<div class="tip-desc"></div>
						<div class="tip-btns">
							<div class="btn-cancel btn">取消</div>
							<div class="tip-confirm btn">确认</div>
						</div>
					</div>
				</div>
				<div class="game-login">
					<form class="login-form">
						<div class="login-title">请输入昵称开始游戏</div>
						<div class="login-info">
							<figure>
								<img src="" draggable="false" title="" />
								<a href="https://www.gravatar.com" target="_blank" rel="nofollow noopener noreferrer">申请头像</a>
							</figure>
							<section>
								<div class="login-user">
									<div class="login-user-inp border-b">
										<input
											class="login-author"
											type="text"
											name="author"
											spellcheck="false"
											maxlength="32"
											required="required"
											placeholder="昵称 *"
											value=""
											autocomplete="off"
											pattern="^[a-zA-Z\u4e00-\u9fa5][a-zA-Z0-9\u4e00-\u9fa5\-·]*[a-zA-Z0-9\u4e00-\u9fa5]?$"
											title="昵称只能包含中英文、数字及连字符-·昵称格式为：[中英文][中英文/数字/连字符-·][中英文/数字]"
										/>
									</div>
									<span class="login-user-toggle"></span>
								</div>
								<div class="login-user border-b">
									<input
										class="login-email"
										type="email"
										name="email"
										spellcheck="false"
										maxlength="70"
										required="required"
										placeholder="邮箱 *"
										value=""
										autocomplete="off"
										pattern="^([a-zA-Z0-9_\.\-])+@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,10})$"
									/>
								</div>
								<div class="login-user border-b">
									<input
										class="login-url"
										type="url"
										name="url"
										spellcheck="false"
										maxlength="70"
										placeholder="网站"
										value=""
										autocomplete="off"
										pattern="^(https?):\/\/[\w\-]+(\.[\w\-]+)+([\w\-\+\.\/~!@#%&amp;_=|;:,?]*[\w\-\+\/~@#%&amp;_=|])?$"
									/>
								</div>
								<div class="login-user">
									<input
										class="login-qq"
										type="text"
										name="qq"
										spellcheck="false"
										maxlength="20"
										placeholder="QQ获取信息"
										autocomplete="off"
										pattern="^[a-zA-Z0-9]{2,10}?$"
										title="QQ号可获取头像和昵称"
									/>
									<img
										class="login-qq-loading"
										src="http://localhost/home/usr/themes/life/common/image/loading.svg"
										alt=""
									/>
								</div>
							</section>
						</div>
						<div class="login-btns">
							<button class="btn-login btn" type="submit">开始游戏</button>
							<div class="btn-guest btn" id="btnGuest">游客模式</div>
						</div>
					</form>
				</div>
				<div class="game-buffalo" id="gameBuffalo"></div>
				<div class="game-mask" id="gameMask">
					<div class="mask-tip">请选择场上1种动物激活，除鸵鸟外都可以点击</div>
					<div class="mask-cancel" id="maskCancel">取消</div>
				</div>
				<div class="game-content">
					<div class="game-stage">
						<div class="game-animals" id="animals"></div>
						<div class="game-title">
							<div class="title" id="targetElement">动物大迁徙</div>
							<div class="game-score">
								<div class="score-text">本局积分</div>
								<div class="score-num" id="score">0</div>
							</div>
						</div>
						<div class="game-round">
							<div class="round-title">第<span id="round">1</span>回合</div>
							<div class="round-section">
								<div class="round-countdown">
									<div class="round-countdown-text">野牛将在<span id="buffaloCountdown">1</span></div>
									<div>回合后来袭</div>
								</div>
							</div>
						</div>
						<div class="game-skill">
							<div class="skill-text" id="skillText">技能</div>
							<div class="progress-wrapper">
								<div class="progress-bar" id="skillProgressFill"></div>
								<div class="progress-points" id="skillPoint">
									<div id="currentPoints">1</div>
									/
									<div id="nextThreshold">1</div>
								</div>
							</div>
						</div>
						<div class="game-bear">
							<img src="./img/bear2.png" alt="" />
							<div class="game-bubble" id="gameBubble">移动<span id="points">1</span>次后解冻</div>
						</div>
					</div>
					<div class="game-wrapper" id="gameWrapper"></div>
				</div>
			</div>
		</div>
		<div class="controls">
			<button id="restartBtn">重新开始</button>
			<button id="hintBtn" style="display: none">提示</button>
			<button id="forback">返回上一步</button>
		</div>
		<div class="instructions">
			<p>
				游戏规则:
				拖拽方块左右移动，当一行填满时会消除得分。每次移动后底部会新增一行方块，所有方块上移一层。当方块堆到顶部时游戏结束。
			</p>
			<div class="improvement-note">
				<strong>新增功能:</strong>
				<ul>
					<li>野牛标记倒计时显示</li>
					<li>冻结技能 - 消耗4格方块获得额外移动机会</li>
					<li>技能点数系统</li>
				</ul>
			</div>
		</div>
		<script src="./js/GameHistory.js"></script>
		<script src="./js/GameState.js"></script>
		<script src="./js/GameSound.js"></script>
		<script src="./js/GameSkill.js"></script>
		<script src="./js/GameLogic.js"></script>
		<script src="./js/GameRenderer.js"></script>
		<script src="./js/GameController.js"></script>
		<script src="./js/Match3Game.js"></script>
		<script>
			document.addEventListener('DOMContentLoaded', () => {
				const game = new Match3Game({
					el: document.getElementById('gameWrapper'),
					boardSize: [9, 11], // 宽高
					cubicBezier: [0.175, 0.885, 0.32, 1.275], // 全局动画缓动
					duration: 120, // 120ms
					gap: 1, // 2px
					buffaloPattern: [20, 20, 20, 10, 10, 10, 10, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 5],
					buffaloLength: 5
				})
				game.start()

				document.getElementById('restartBtn').addEventListener('click', game.restart.bind(game))
				document.getElementById('hintBtn').addEventListener('click', getUser.bind(event, game))
				document.getElementById('forback').addEventListener('click', game.undo.bind(game))
			})

			// 获取DOM元素
			const targetElement = document.getElementById('targetElement')
			const hiddenButton = document.getElementById('hintBtn')
			let lastTap = 0
			let tapTimeout

			// 添加触摸事件监听器（移动端）
			targetElement.addEventListener('touchstart', function (e) {
				e.preventDefault()

				const currentTime = new Date().getTime()
				const tapLength = currentTime - lastTap

				clearTimeout(tapTimeout)

				if (tapLength > 0 && tapLength < 300) {
					hiddenButton.style.display = 'block'
					lastTap = 0
				} else {
					tapTimeout = setTimeout(() => {
						lastTap = 0
					}, 300)
					lastTap = currentTime
				}
			})

			targetElement.addEventListener('dblclick', () => (hiddenButton.style.display = 'block'))

			// 防止移动端长按弹出菜单
			targetElement.addEventListener('contextmenu', function (e) {
				e.preventDefault()
			})

			function getUser(game) {
				const data = new FormData()

				data.append('routeType', 'gameAIAction')
				data.append('rows', game.state.boardSizeH)
				data.append('cols', game.state.boardSizeX)
				data.append('board', JSON.stringify(game.state.board))
				data.append('nextRow', JSON.stringify(game.renderer.nextRow))

				fetch('https://luszy.com/home/y/api', {
					method: 'POST',
					body: data
				})
					.then((response) => {
						// 检查 HTTP 响应状态
						if (!response.ok) {
							return response
								.json()
								.then((errData) => {
									throw new Error(errData.message || `请求失败，状态码: ${response.status}`)
								})
								.catch(() => {
									throw new Error(`请求失败，状态码: ${response.status}`)
								})
						}
						return response.json()
					})
					.then(({ code, message, result }) => {
						if (code === 0) {
							game.suggestMove(result)
							return
						}
						console.error('AI请求失败:', message)
					})
					.catch((error) => {
						console.error('AI请求出错:', error)
					})
			}
		</script>
	</body>
</html>
