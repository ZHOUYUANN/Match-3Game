<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>方块消除游戏 - 技能系统</title>
		<link rel="stylesheet" href="./css/style.css" />
	</head>
	<body>
		<div class="game">
			<div class="game-container" id="gameContainer">
				<div class="game-tip" style="display: none">
					<div class="tip-title">提示</div>
					<div class="tip-content">
						<div>是否激活【北极熊<span>X2</span>】</div>
						<div class="tip-anmail"></div>
						<div class="tip-desc"></div>
						<div class="tip-btns">
							<div class="btn-cancel btn">取消</div>
							<div class="tip-confirm btn">确认</div>
						</div>
					</div>
				</div>
				<div class="game-login" id="gameLogin">
					<form class="login-form" id="loginForm">
						<div class="login-title">请输入昵称开始游戏</div>
						<div class="login-info">
							<figure>
								<img
									src="https://luszy.com/home/usr/themes/life/common/image/noavatar.png"
									draggable="false"
									title=""
								/>
								<a href="https://www.gravatar.com/" target="_blank" rel="nofollow noopener noreferrer">申请头像</a>
							</figure>
							<section>
								<div class="login-user border-b">
									<input
										class="login-author"
										type="text"
										name="author"
										spellcheck="false"
										maxlength="32"
										required="required"
										placeholder="昵称 *"
										value=""
										autocomplete="off"
										pattern="^[a-zA-Z\u4e00-\u9fa5][a-zA-Z0-9\u4e00-\u9fa5\-·]*[a-zA-Z0-9\u4e00-\u9fa5]?$"
										title="昵称只能包含中英文、数字及连字符-·昵称格式为：[中英文][中英文/数字/连字符-·][中英文/数字]"
									/>
								</div>
								<div class="login-user border-b">
									<input
										class="login-email"
										type="email"
										name="email"
										spellcheck="false"
										maxlength="70"
										required="required"
										placeholder="邮箱 *"
										value=""
										autocomplete="off"
										pattern="^([a-zA-Z0-9_\.\-])+@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,10})$"
									/>
								</div>
								<div class="login-user border-b">
									<input
										class="login-url"
										type="url"
										name="url"
										spellcheck="false"
										maxlength="70"
										placeholder="网站"
										value=""
										autocomplete="off"
										pattern="^(https?):\/\/[\w\-]+(\.[\w\-]+)+([\w\-\+\.\/~!@#%&amp;_=|;:,?]*[\w\-\+\/~@#%&amp;_=|])?$"
									/>
								</div>
								<div class="login-user">
									<input
										id="loginQQ"
										class="login-qq"
										type="text"
										name="qq"
										spellcheck="false"
										maxlength="20"
										placeholder="建议直接使用QQ号获取信息"
										autocomplete="off"
										pattern="^[a-zA-Z0-9]{2,10}?$"
										title="QQ号可获取头像和昵称"
									/>
									<img
										class="login-qq-loading"
										src="https://luszy.com/home/usr/themes/life/common/image/loading.svg"
										alt=""
									/>
								</div>
							</section>
						</div>
						<div class="login-btns">
							<button class="btn-login btn" type="submit">开始游戏</button>
							<div class="btn-guest btn" onclick="document.getElementById('gameLogin').classList.remove('show')">
								取消
							</div>
						</div>
						<div class="login-tip" id="loginTip"></div>
					</form>
				</div>
				<div class="game-rank" id="gameRank">
					<div class="rank-container">
						<div class="rank-close" onclick="document.getElementById('gameRank').classList.remove('show')">×</div>
						<div class="rank-header">
							<h2>排行榜</h2>
						</div>
						<div class="rank-podium">
							<div class="podium-item rank-1">
								<div class="crown-icon">👑</div>
								<div class="podium-avatar">
									<img src="https://api.dicebear.com/7.x/avataaars/svg?seed=King" alt="1st" />
									<span class="badge">1</span>
								</div>
								<div class="podium-info">
									<div class="name">张三</div>
									<div class="score">0</div>
								</div>
							</div>
							<div class="podium-item rank-2">
								<div class="podium-avatar">
									<img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" alt="2nd" />
									<span class="badge">2</span>
								</div>
								<div class="podium-info">
									<div class="name">李四</div>
									<div class="score">0</div>
								</div>
							</div>
							<div class="podium-item rank-3">
								<div class="podium-avatar">
									<img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Annie" alt="3rd" />
									<span class="badge">3</span>
								</div>
								<div class="podium-info">
									<div class="name">王五</div>
									<div class="score">0</div>
								</div>
							</div>
						</div>
						<div class="rank-list">
							<ul>
								<div class="list-none">暂无数据</div>
							</ul>
						</div>
						<div class="rank-self">
							<span class="num">0</span>
							<img class="avatar" src="https://luszy.com/home/usr/themes/life/common/image/noavatar.png" alt="" />
							<div class="info">
								<span class="name">我 (You)</span>
								<span class="desc">还差 0 分超越上一名</span>
							</div>
							<span class="score">0</span>
						</div>
					</div>
				</div>
				<div class="game-buffalo" id="gameBuffalo"></div>
				<div class="game-mask" id="gameMask">
					<div class="mask-tip">请选择场上1种动物激活，除鸵鸟外都可以点击</div>
					<div class="mask-cancel" id="maskCancel">取消</div>
				</div>
				<div class="game-content">
					<div class="game-stage">
						<div class="game-animals" id="animals"></div>
						<div class="game-title">
							<div class="title" id="targetElement">动物大迁徙</div>
							<div class="game-score">
								<div class="score-text">本局积分</div>
								<div class="score-num" id="score">0</div>
							</div>
						</div>
						<div class="game-user">
							<figure class="user-avatar">
								<img
									src="https://luszy.com/home/usr/themes/life/common/image/noavatar.png"
									draggable="false"
									id="userAvatarImg"
								/>
							</figure>
							<div class="user-details">
								<div class="user-name" id="userName">游客</div>
								<div class="rank-entry" onclick="document.getElementById('gameRank').classList.add('show')">
									<span class="rank-icon">🏆</span>
									<span class="rank-text">排行榜</span>
								</div>
							</div>
						</div>
						<div class="game-round">
							<div class="round-title">第<span id="round">1</span>回合</div>
							<div class="round-section">
								<div class="round-countdown">
									<div class="round-countdown-text">野牛将在<span id="buffaloCountdown">1</span></div>
									<div>回合后来袭</div>
								</div>
							</div>
						</div>
						<div class="game-skill">
							<div class="skill-text" id="skillText">技能</div>
							<div class="progress-wrapper">
								<div class="progress-bar" id="skillProgressFill"></div>
								<div class="progress-points" id="skillPoint">
									<div id="currentPoints">1</div>
									/
									<div id="nextThreshold">1</div>
								</div>
							</div>
						</div>
						<div class="game-bear">
							<img src="./img/bear2.png" alt="" />
							<div class="game-bubble" id="gameBubble">移动<span id="points">1</span>次后解冻</div>
						</div>
					</div>
					<div class="game-wrapper" id="gameWrapper"></div>
				</div>
			</div>
		</div>
		<div class="controls">
			<button id="restartBtn">重新开始</button>
			<button id="hintBtn">提示</button>
			<button id="forback">返回上一步</button>
		</div>
		<div class="instructions">
			<p>
				游戏规则:
				拖拽方块左右移动，当一行填满时会消除得分。每次移动后底部会新增一行方块，所有方块上移一层。当方块堆到顶部时游戏结束。
			</p>
			<div class="improvement-note">
				<strong>新增功能:</strong>
				<ul>
					<li>野牛标记倒计时显示</li>
					<li>冻结技能 - 消耗4格方块获得额外移动机会</li>
					<li>技能点数系统</li>
				</ul>
			</div>
		</div>
		<script src="./js/GameAI3.js"></script>
		<script src="./js/GameHistory.js"></script>
		<script src="./js/GameState.js"></script>
		<script src="./js/GameSound.js"></script>
		<script src="./js/GameSkill.js"></script>
		<script src="./js/GameLogic.js"></script>
		<script src="./js/GameRenderer.js"></script>
		<script src="./js/GameController.js"></script>
		<script src="./js/Match3Game.js"></script>
		<script>
			document.addEventListener('DOMContentLoaded', () => {
				const game = new Match3Game({
					el: document.getElementById('gameWrapper'),
					boardSize: [9, 11], // 宽高
					cubicBezier: [0.175, 0.885, 0.32, 1.275], // 全局动画缓动
					duration: 120, // 120ms
					gap: 1, // 2px
					buffaloPattern: [20, 20, 20, 10, 10, 10, 10, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 5],
					buffaloLength: 5
				})
				game.start()

				game.on('gameOver', ({ score }) => {
					console.log('游戏结束！您的得分是：' + score)
					doAction({
						routeType: 'setGameUserScoreActive',
						score
					}).then(({ code, result }) => {
						if (code !== 0) return
						getGameLeaderboardActionData()
					})
				})
				document.getElementById('restartBtn').addEventListener('click', game.restart.bind(game))
				// document.getElementById('hintBtn1').addEventListener('click', game.suggestMove.bind(game, null))
				document.getElementById('hintBtn').addEventListener('click', getUser.bind(event, game))
				document.getElementById('forback').addEventListener('click', game.undo.bind(game))

				// 获取DOM元素
				const targetElement = document.getElementById('targetElement')
				const hiddenButton = document.getElementById('hintBtn')
				let lastTap = 0
				let tapTimeout

				// 添加触摸事件监听器（移动端）
				targetElement.addEventListener('touchstart', function (e) {
					e.preventDefault()

					const currentTime = new Date().getTime()
					const tapLength = currentTime - lastTap

					clearTimeout(tapTimeout)

					if (tapLength > 0 && tapLength < 300) {
						hiddenButton.style.display = 'block'
						lastTap = 0
					} else {
						tapTimeout = setTimeout(() => {
							lastTap = 0
						}, 300)
						lastTap = currentTime
					}
				})

				targetElement.addEventListener('dblclick', () => (hiddenButton.style.display = 'block'))

				// 防止移动端长按弹出菜单
				targetElement.addEventListener('contextmenu', function (e) {
					e.preventDefault()
				})

				getGameUserStatusActionData()
				getGameLeaderboardActionData()

				document.getElementById('loginForm').addEventListener('submit', (event) => {
					event.preventDefault()
					event.stopPropagation()
					registerGameUserActionData()
				})

				document.getElementById('loginQQ').addEventListener('blur', (event) => {
					event.preventDefault()
					event.stopPropagation()
					getQQInfoActionData()
				})
			})

			function updateUser(data) {
				const imgElement = document.querySelector('.game-user figure img')
				imgElement.src = data.avatar || 'https://luszy.com/home/usr/themes/life/common/image/noavatar.png'
				document.getElementById('userName').innerText = data.author || '游客'
				document.getElementById('gameLogin').classList.remove('show')
			}
			// 封装一个AJAX请求函数
			function doAction(data = {}) {
				return new Promise((resolve) => {
					const formData = new FormData()
					for (const key in data) {
						formData.append(key, data[key])
					}
					fetch(`http://localhost/home/index.php/y/api`, {
						method: 'POST',
						body: formData
					})
						.then((response) => {
							// 检查 HTTP 响应状态
							if (!response.ok) {
								return response
									.json()
									.then((errData) => {
										throw new Error(errData.message || `请求失败，状态码: ${response.status}`)
									})
									.catch(() => {
										throw new Error(`请求失败，状态码: ${response.status}`)
									})
							}
							return response.json()
						})
						.then((res) => resolve(res))
						.catch((error) => console.error('AI请求出错:', error))
				})
			}

			async function getUser(game) {
				const { code, result } = await doAction({
					routeType: 'gameAIAction',
					rows: game.state.boardSizeH,
					cols: game.state.boardSizeX,
					board: JSON.stringify(game.state.board),
					nextRow: JSON.stringify(game.renderer.nextRow)
				})
				if (code !== 0) return
				game.suggestMove(result)
			}

			function getGameUserStatusActionData() {
				doAction({ routeType: 'getGameUserStatusAction' }).then(({ code, result }) => {
					if (code !== 0) {
						document.getElementById('loginTip').innerText =
							'*当前为游客模式，游戏数据不会被保存，请注册账号以保存进度！'
						document.getElementById('gameLogin').classList.add('show')
					}
					updateUser(result)
				})
			}

			function getGameLeaderboardActionData() {
				doAction({ routeType: 'getGameLeaderboardAction' }).then(({ code, result }) => {
					if (code !== 0) {
						return
					}
					// 取出前三名
					const podium = result.leaderboard.slice(0, 3)
					podium.forEach((user, index) => {
						const podiumItem = document.querySelector(`.podium-item.rank-${index + 1}`)
						podiumItem.querySelector('.podium-avatar img').src =
							user.avatar || 'https://luszy.com/home/usr/themes/life/common/image/noavatar.png'
						podiumItem.querySelector('.podium-info .name').innerText = user.author || '游客'
						podiumItem.querySelector('.podium-info .score').innerText = user.score.toLocaleString()
					})
					// 第三名以后循环插入
					const rankList = document.querySelector('.rank-list ul')
					result.leaderboard.slice(3).forEach((user, index) => {
						const li = document.createElement('li')
						li.innerHTML = `
							<span class="num">${index + 4}</span>
							<img class="avatar" src="${user.avatar || 'https://luszy.com/home/usr/themes/life/common/image/noavatar.png'}" alt="" />
							<span class="name">${user.author || '游客'}</span>
							<span class="score">${user.score.toLocaleString()}</span>
						`
						rankList.appendChild(li)
					})
					// 设置自己的名次
					if (result.myInfo) {
						if (result.myInfo.isTop) {
							document.querySelector('.rank-self').style.display = 'none'
							return
						}
						const { rank, author, avatar, score, gapToPrevious } = result.myInfo
						document.querySelector('.rank-self .num').innerText = rank
						document.querySelector('.rank-self .avatar').src =
							avatar || 'https://luszy.com/home/usr/themes/life/common/image/noavatar.png'
						document.querySelector('.rank-self .info .name').innerText = author || '游客'
						document.querySelector(
							'.rank-self .info .desc'
						).innerText = `还差 ${gapToPrevious.toLocaleString()} 分超越上一名`
						document.querySelector('.rank-self .score').innerText = score.toLocaleString()
					} else {
						document.querySelector('.rank-self').style.display = 'none'
					}
				})
			}

			function registerGameUserActionData() {
				doAction({
					routeType: 'registerGameUserAction',
					author: document.querySelector('.login-author').value,
					mail: document.querySelector('.login-email').value,
					url: document.querySelector('.login-url').value
				}).then(({ code, result }) => {
					if (code !== 0) return
					updateUser(result)
				})
			}

			function getQQInfoActionData() {
				const load = document.querySelector('.login-qq-loading')
				const qq = document.querySelector('.login-qq')

				if (!qq.value) return
				if (!/^[1-9]\d{4,10}?$/.test(qq.value)) {
					alert('QQ 格式错误，请重新输入')
					return
				}

				qq.setAttribute('disabled', '')
				load.classList.add('show')

				doAction({
					routeType: 'getQQInfoAction',
					qq: qq.value
				}).then(({ code, result }) => {
					if (code !== 0) return
					qq.value = ''
					qq.removeAttribute('disabled')
					load.classList.remove('show')
					document.querySelector('.login-author').value = result.nickname
					document.querySelector('.login-email').value = result.mail
					document.querySelector('.login-info figure img').setAttribute('src', result.avatar)
				})
			}
		</script>
	</body>
</html>
